<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ログイン</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ログイン</h1>

  <button id="google-login">Googleでログイン</button>
  <p>または</p>
  <input type="email" id="email" placeholder="メールアドレス">
  <input type="password" id="password" placeholder="パスワード">
  <button id="email-login">メールでログイン</button>
  <p id="status"></p>

  <script type="module">
    import { auth, provider, db } from './firebase.js';
    import { signInWithPopup, signInWithEmailAndPassword, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const status = document.getElementById('status');

    document.getElementById('google-login').onclick = async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        await initUserData(result.user);
        location.href = "mypage.html";
      } catch (e) {
        status.textContent = e.message;
      }
    };

    document.getElementById('email-login').onclick = async () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        await initUserData(cred.user);
        location.href = "mypage.html";
      } catch (e) {
        if (e.code === "auth/user-not-found") {
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          await initUserData(cred.user);
          location.href = "mypage.html";
        } else {
          status.textContent = e.message;
        }
      }
    };

    async function initUserData(user) {
      const docRef = doc(db, "users", user.uid);
      const snap = await getDoc(docRef);
      if (!snap.exists()) {
        const handle = "user-" + Math.random().toString(36).substring(2, 12);
        await setDoc(docRef, {
          uid: user.uid,
          email: user.email || null,
          provider: user.providerData[0]?.providerId || "unknown",
          createdAt: new Date(),
          handle
        });
      }
    }
  </script>
</body>
</html>
